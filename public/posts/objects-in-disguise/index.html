<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=59088&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Objects in Disguise ü•∑üèΩ: Unmasking V8‚Äôs Secret Operations Behind the Scenes - Ojas Gupta Blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Discover how the V8 engine quietly morphs your JavaScript objects using hidden classes, inline caches, and other under the hood tricks." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:59088/posts/objects-in-disguise/">
  <meta property="og:site_name" content="Ojas Gupta Blog">
  <meta property="og:title" content="Objects in Disguise ü•∑üèΩ: Unmasking V8‚Äôs Secret Operations Behind the Scenes">
  <meta property="og:description" content="Discover how the V8 engine quietly morphs your JavaScript objects using hidden classes, inline caches, and other under the hood tricks.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-19T15:00:00+10:00">
    <meta property="article:modified_time" content="2025-06-19T15:00:00+10:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Objects in Disguise ü•∑üèΩ: Unmasking V8‚Äôs Secret Operations Behind the Scenes">
  <meta name="twitter:description" content="Discover how the V8 engine quietly morphs your JavaScript objects using hidden classes, inline caches, and other under the hood tricks.">

        <link href="http://localhost:59088/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:59088/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css" />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:59088/">Ojas Gupta Blog</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Objects in Disguise ü•∑üèΩ: Unmasking V8‚Äôs Secret Operations Behind the Scenes</h1>
          <div class="meta">Posted on Jun 19, 2025</div>
        </div>
        
        <section class="body">
          <h1 id="introduction">Introduction</h1>
<p>In this article we will explore some ways V8 optimizes your Javascript code. I will share some of the knowledge I have learnt over the past few weeks reading blogs.</p>
<p>Bonus Points!! if you&rsquo;re interested in using this knowledge to exploit web browsers (for educational purposes, obviously).</p>
<h1 id="the-purpose-of-v8">The purpose of V8</h1>
<p>As web applications become the new normal for many people around the globe. Google set out on a journey to make web browsers run applications as smoothly desktop applications. As a result of this, V8 was born.</p>
<p>V8 is an open source engine used in Google Chrome to execute Javascript code. Its responsible for translating Javascript into machine code directly and also optimizes javascript execution. This engine adapted to a bunch of different strategies to optimizing code behind the scenes.</p>
<h1 id="what-are-objects--properties">What are Objects &amp; Properties?</h1>
<p>In Javascript an object is basically a hashmap (key-value) pair but with extra features. Lets take a look at a very basic Javascript object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Javascript" data-lang="Javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">age</span>, <span style="color:#a6e22e">breed</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">age</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">age</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">breed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">breed</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#e6db74">&#34;Buddy&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;Golden Retriever&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Accessing properties
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">name</span>);  <span style="color:#75715e">// &#34;Buddy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">age</span>);   <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">breed</span>)  <span style="color:#75715e">// &#34;Golden Retriever&#34;
</span></span></span></code></pre></div><p>In this object the properties are <code>name</code>, <code>age</code> and <code>breed</code>.</p>
<h1 id="hidden-classes">Hidden Classes</h1>
<p>Hidden Classes have multiple different names, some people call them shapes, V8 calls them Maps, in Chakra they are defined as Types and JavascriptCore will call them Structures.</p>
<p>Hidden Classes were created to make accessing property values faster. In languages such as Java, the location of a property can be very easily found through a single instruction. In Javascript, this requires more than just a single instruction. Here is an example of a simple property retrieval from the early days of JavaScript :</p>
<pre tabindex="0"><code>[[Get]](P)
When the [[Get]] method of O is called with property name P, the following steps are taken:

1. If O doesn&#39;t have a property with name P, go to step 4.

2. Get the value of the property.

3. Return Result(2).

4. If the [[Prototype]] of O is null, return undefined.

5. Call the [[Get]] method of [[Prototype]] with property name P.

6. Return Result(5).
</code></pre><p>As you can see property retrieval takes quite the number of instructions. For a more modern day algorithm, you can look at <a href="https://read262.jedfox.com/ordinary-and-exotic-objects-behaviours/ordinary-object-internal-methods-and-internal-slots/#sec-ordinaryget">this link</a> and scroll down to section 10.1.8 [[Get]] (P, Receiver).</p>
<p>Now you may be wondering how hidden classes make property access faster?</p>
<p>The reality is maps have the capacity to be computationally expensive which can slow down our applications. Through the use of hidden classes we can avoid a dictionary lookup when we access our properties and then combine them with a technique called inline caching (we will discuss this one later).</p>
<p>Lets use our example code to show how hidden classes work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JS" data-lang="JS"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#e6db74">&#34;Buddy&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;Golden Retriever&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d2</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#e6db74">&#34;Bruno&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d3</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#e6db74">&#34;Milo&#34;</span>, <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p>We will start with <code>d1</code>, at the beginning it will point to a empty class.</p>
<p><img src="/img/first.png" alt="alt text"></p>
<p>As it processes the values and creates the shapes, it will create a transition diagram from <code>C0</code> to <code>C1</code>. This essentially means if shape has a <code>name</code> property use <code>C1</code>.</p>
<p><img src="/img/second.png" alt="alt text"></p>
<p>Now what happens when V8 processes the <code>age</code> in our dog? V8 will create another hidden class and make a transition between <code>C1</code> and <code>C2</code>.</p>
<p><img src="/img/third.png" alt="alt text"></p>
<p>After processing the <code>breed</code> of our dog, the third and the final hidden class will be created.</p>
<p><img src="/img/fourth.png" alt="alt text"></p>
<p>V8 will then process <code>d2</code> and <code>d3</code> from our code above resulting in the final diagram looking like this:
<img src="/img/final.png" alt="alt text"></p>
<p>Since we can see the offsets created, this strategy avoids a dictionary lookup of the object plus walking through the prototype and its prototypes and then its prototypes etc. Effectively simplifying our algorithm.</p>
<h1 id="inline-caching">Inline Caching</h1>
<p>Inline caching is often combined with hidden classes to speed up the lookup process.</p>
<p>Lets use this function this function as an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Javascript" data-lang="Javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getName</span>(<span style="color:#a6e22e">dog</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dog</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first time we run <code>getName</code>, the method fetches the offset from <code>C3</code>.
<img src="/img/inline-cache-1.png" alt="alt text"></p>
<p>Lets create another object and call it d4.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d4</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Dog</span>(<span style="color:#e6db74">&#34;Jack&#34;</span>, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;Labrador&#34;</span>)
</span></span></code></pre></div><p>If we call <code>d4</code> or object like <code>d4</code> multiple times using <code>getName(dog)</code>, an inline cache will be created. For further understanding, lets expand the function <code>getName</code> into its bytecode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> @MacBook-Air ~ % d8 --print-bytecode --print-bytecode-filter<span style="color:#f92672">=</span>getName --no-lazy dogs.js
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>generated bytecode <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span>: getName <span style="color:#f92672">(</span>0x2fd0001997c5 &lt;SharedFunctionInfo getName&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>Bytecode length: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Parameter count <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Register count <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Frame size <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>         0x19c9001400b8 @    <span style="color:#ae81ff">0</span> : <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>       GetNamedProperty a0, <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>, <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>         0x19c9001400bc @    <span style="color:#ae81ff">4</span> : b3                Return
</span></span><span style="display:flex;"><span>Constant pool <span style="color:#f92672">(</span>size <span style="color:#f92672">=</span> 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Handler Table <span style="color:#f92672">(</span>size <span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Source Position Table <span style="color:#f92672">(</span>size <span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Lets replace the <code>getName</code> function with its bytecode to get a better picture.</p>
<p><img src="/img/inline-cache-2.png" alt="alt text"></p>
<p>The <code>GetNameProperty</code> will load the first parameter<code>a0</code> as the first argument of the function which in this case is <code>dog</code>. The 0 signifies the argument number, for this example it implies the first argument, if we passed more than one argument then in the bytecode you would see <code>a1....an</code> where n is the number of arguments you passed.</p>
<p>If we keep executing the getName function with the shape <code>C3</code> from our earlier example, it will remember the offset for <code>dog.name</code> which in this case is 0.
We know from our previous examples that the offset for <code>name</code> is 0. In this case the assumed shape will be <code>C3</code>. For future runs V8 will compare the shape, if the shape is the same then it will used the cached values to speed up the look up process.</p>
<p>The third argument of <code>GetNamedProperty</code> is another <code>[0]</code> but this one is a feedback vector. A feedback vector is a data structure where the inline cache is stored. Turbofan, V8&rsquo;s optimizer will run this assembly line,  <code>mov eax, [eax + 0xb]</code>. This will return the key for you. Michael Stanton has a good talk about this topic called &ldquo;V8 and How It Listens to You&rdquo;.</p>
<p>Here is a visual diagram of the entire process:</p>
<p><img src="/img/inline-cache-diagram.png" alt="alt text"></p>
<p>If you would like a deeper look, here is the assembly code from Michael Stanton at Google:
<img src="/img/inline-cache-assembly.png" alt="alt text"></p>
<h1 id="references">References:</h1>
<p><a href="https://dev.to/_staticvoid/node-js-under-the-hood-8-oh-the-bytecodes-1p6p">https://dev.to/_staticvoid/node-js-under-the-hood-8-oh-the-bytecodes-1p6p</a></p>
<p><a href="https://jhalon.github.io/chrome-browser-exploitation-1/">https://jhalon.github.io/chrome-browser-exploitation-1/</a></p>
<p><a href="https://www.youtube.com/watch?v=u7zRSm8jzvA">https://www.youtube.com/watch?v=u7zRSm8jzvA</a></p>
<p><a href="https://mathiasbynens.be/notes/shapes-ics">https://mathiasbynens.be/notes/shapes-ics</a></p>
<p><a href="https://richardartoul.github.io/jekyll/update/2015/04/26/hidden-classes.html">https://richardartoul.github.io/jekyll/update/2015/04/26/hidden-classes.html</a></p>
<p><a href="https://stackoverflow.com/questions/50044735/what-is-a-feedbackvector-in-v8">https://stackoverflow.com/questions/50044735/what-is-a-feedbackvector-in-v8</a></p>
<p><a href="https://draft.li/blog/2016/12/22/javascript-engines-hidden-classes/">https://draft.li/blog/2016/12/22/javascript-engines-hidden-classes/</a></p>
<p><a href="https://javascript.plainenglish.io/v8-engine-and-inline-caching-in-javascript-fef80054a551">https://javascript.plainenglish.io/v8-engine-and-inline-caching-in-javascript-fef80054a551</a></p>
<p><a href="https://chromium.googlesource.com/external/github.com/v8/v8.wiki/%2B/60dc23b22b18adc6a8902bd9693e386a3748040a/Design-Elements.md">https://chromium.googlesource.com/external/github.com/v8/v8.wiki/%2B/60dc23b22b18adc6a8902bd9693e386a3748040a/Design-Elements.md</a></p>

        </section>
        <div class="post-tags">
          
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2025  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>

</div>
    </body>
</html>
